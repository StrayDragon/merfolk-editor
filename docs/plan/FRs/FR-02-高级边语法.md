# FR-02: é«˜çº§è¾¹è¯­æ³•

> ä¼˜å…ˆçº§: P0 | çŠ¶æ€: âœ… å®Œæˆ

## ğŸ“‹ æ¦‚è¿°

å¢å¼ºè¾¹(Edge)è§£æèƒ½åŠ›ï¼Œæ”¯æŒæ‰€æœ‰ Mermaid è¾¹è¯­æ³•å˜ä½“ã€‚

å‚è€ƒ: [Mermaid Flowchart - Links](https://mermaid.js.org/syntax/flowchart.html#links-between-nodes)

---

## ğŸ¯ éœ€æ±‚

### 2.1 ç©ºæ ¼åˆ†éš”çš„æ–‡æœ¬è¯­æ³• (å½“å‰å¤±è´¥ âŒ)

**è¯­æ³•:**
```mermaid
A -- text --> B     %% ç©ºæ ¼åˆ†éš”æ–‡æœ¬ + ç®­å¤´
A -- text --- B     %% ç©ºæ ¼åˆ†éš”æ–‡æœ¬ + æ— ç®­å¤´
A -. text .-> B     %% è™šçº¿ + ç©ºæ ¼æ–‡æœ¬
A == text ==> B     %% ç²—çº¿ + ç©ºæ ¼æ–‡æœ¬
```

**å½“å‰é—®é¢˜:** è§£æå™¨æœªèƒ½æ­£ç¡®æå–ç©ºæ ¼åˆ†éš”çš„è¾¹æ–‡æœ¬ã€‚

### 2.2 ä¸å¯è§è¾¹ (å¾…å®ç°)

**è¯­æ³•:**
```mermaid
A ~~~ B
```

ç”¨äºå¸ƒå±€è°ƒæ•´ï¼Œä¸æ¸²æŸ“å¯è§è¿çº¿ã€‚

### 2.3 å¤šèŠ‚ç‚¹é“¾æ¥ & (å¾…å®ç°)

**è¯­æ³•:**
```mermaid
A & B --> C         %% A-->C, B-->C (2 æ¡è¾¹)
A --> B & C         %% A-->B, A-->C (2 æ¡è¾¹)
A & B --> C & D     %% ç¬›å¡å°”ç§¯ (4 æ¡è¾¹)
```

### 2.4 è¾¹é•¿åº¦æ§åˆ¶ (å¾…å®ç°)

**è¯­æ³•:**
```mermaid
A --> B             %% é»˜è®¤é•¿åº¦ 1
A ---> B            %% é•¿åº¦ 2
A ----> B           %% é•¿åº¦ 3
A -.-> B            %% è™šçº¿é»˜è®¤é•¿åº¦ 1
A -..-> B           %% è™šçº¿é•¿åº¦ 2
A ==> B             %% ç²—çº¿é»˜è®¤é•¿åº¦ 1
A ===> B            %% ç²—çº¿é•¿åº¦ 2
```

### 2.5 è¾¹ ID å’ŒåŠ¨ç”» (å¾…å®ç°)

**è¾¹ ID è¯­æ³•:**
```mermaid
A e1@--> B          %% è¾¹ ID ä¸º e1
```

**è¾¹å±æ€§é…ç½®:**
```mermaid
A e1@--> B
e1@{ animate: true }
e1@{ animation: fast }  %% slow, normal, fast
```

### 2.6 linkStyle (å¾…å®ç°)

**è¯­æ³•:**
```mermaid
linkStyle 0 stroke:#ff3,stroke-width:4px
linkStyle 1,2 stroke:#00f
linkStyle default stroke:#333
```

---

## ğŸ”§ å®ç°

### Parser ä¿®æ”¹

**æ–‡ä»¶:** `src/core/parser/MermaidParser.ts`

#### 2.1 ä¿®å¤ç©ºæ ¼æ–‡æœ¬è§£æ

å½“å‰æ­£åˆ™æ— æ³•åŒ¹é… `A -- text --> B` æ ¼å¼ã€‚

**ä¿®æ”¹ `splitByEdges`:**

```typescript
// éœ€è¦å¤„ç†çš„è¾¹ç±»å‹æ­£åˆ™
const EDGE_PATTERNS = {
  // å¸¦æ–‡æœ¬çš„ç©ºæ ¼è¯­æ³• (ä¼˜å…ˆåŒ¹é…)
  textNormal: /--\s+(.+?)\s+-->/,      // A -- text --> B
  textThick: /==\s+(.+?)\s+==>/,       // A == text ==> B
  textDotted: /-\.\s*(.+?)\s*\.->/,    // A -. text .-> B
  // æ— æ–‡æœ¬çš„è¾¹
  normal: /-->/,
  thick: /==>/,
  dotted: /-\.->|--\.>/,
  // ...
};
```

#### 2.2 æ·»åŠ ä¸å¯è§è¾¹

```typescript
// æ·»åŠ  invisible è¾¹ç±»å‹
const INVISIBLE_EDGE = /~~~/;
```

#### 2.3 å¤šèŠ‚ç‚¹é“¾æ¥å±•å¼€

```typescript
private expandMultiNodeLinks(line: string): string[] {
  // æ£€æµ‹ & æ“ä½œç¬¦
  // ä¾‹: "A & B --> C & D"
  // å±•å¼€ä¸º: ["A --> C", "A --> D", "B --> C", "B --> D"]
}
```

#### 2.4 è¾¹é•¿åº¦è®¡ç®—

```typescript
private parseEdgeLength(operator: string): number {
  // ç»Ÿè®¡ - æˆ– = çš„æ•°é‡
  // --> = 1, ---> = 2, ----> = 3
  const dashes = operator.match(/-+/)?.[0].length ?? 2;
  return Math.max(1, dashes - 1);
}
```

### Model ä¿®æ”¹

**æ–‡ä»¶:** `src/core/model/Edge.ts`

æ·»åŠ æ–°å±æ€§:
```typescript
interface EdgeData {
  // ç°æœ‰
  id: string;
  source: string;
  target: string;
  text?: string;
  stroke: StrokeType;
  arrowStart: ArrowType;
  arrowEnd: ArrowType;
  // æ–°å¢
  length?: number;           // è¾¹é•¿åº¦
  isUserDefinedId?: boolean; // æ˜¯å¦ç”¨æˆ·å®šä¹‰ ID
  animate?: boolean;         // æ˜¯å¦åŠ¨ç”»
  animation?: 'slow' | 'normal' | 'fast';
  style?: Record<string, string>; // linkStyle
}
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### æµ‹è¯•ç”¨ä¾‹

```typescript
// 2.1 ç©ºæ ¼æ–‡æœ¬è¯­æ³•
it('è§£æ A -- text --> B', () => {
  const model = parser.parse('flowchart LR\n  A -- text --> B');
  expect(model.edges[0].text).toBe('text');
  expect(model.edges[0].arrowEnd).toBe('arrow');
});

it('è§£æ A -. text .-> B', () => {
  const model = parser.parse('flowchart LR\n  A -. text .-> B');
  expect(model.edges[0].text).toBe('text');
  expect(model.edges[0].stroke).toBe('dotted');
});

// 2.2 ä¸å¯è§è¾¹
it('è§£æä¸å¯è§è¾¹ ~~~', () => {
  const model = parser.parse('flowchart LR\n  A ~~~ B');
  expect(model.edges[0].stroke).toBe('invisible');
});

// 2.3 å¤šèŠ‚ç‚¹é“¾æ¥
it('A & B --> C å±•å¼€ä¸º 2 æ¡è¾¹', () => {
  const model = parser.parse('flowchart LR\n  A & B --> C');
  expect(model.edgeCount).toBe(2);
  expect(model.edges.find(e => e.source === 'A' && e.target === 'C')).toBeDefined();
  expect(model.edges.find(e => e.source === 'B' && e.target === 'C')).toBeDefined();
});

// 2.4 è¾¹é•¿åº¦
it('è¾¹é•¿åº¦æ­£ç¡®è®¡ç®—', () => {
  const model = parser.parse('flowchart TD\n  A ---> B\n  C ----> D');
  expect(model.edges[0].length).toBe(2);
  expect(model.edges[1].length).toBe(3);
});

// 2.5 è¾¹ ID
it('è¾¹ ID è¯­æ³•', () => {
  const model = parser.parse('flowchart LR\n  A e1@--> B');
  expect(model.edges[0].id).toBe('e1');
  expect(model.edges[0].isUserDefinedId).toBe(true);
});
```

---

## ğŸ“Š å½“å‰å¤±è´¥æµ‹è¯•

æ¥è‡ª `MermaidParser.compat.test.ts`:

| æµ‹è¯• | é—®é¢˜ |
|------|------|
| âŒ 3.4 å¸¦æ–‡æœ¬çš„è¾¹ -- text --> | `text` æœªè¢«è§£æ |
| âŒ 3.6 å¸¦æ–‡æœ¬è™šçº¿è¾¹ -. text .-> | `text` æœªè¢«è§£æ |
| âŒ 3.8 å¸¦æ–‡æœ¬ç²—çº¿è¾¹ == text ==> | `text` æœªè¢«è§£æ |
| âŒ 4.2 å¸¦æ–‡æœ¬çš„èŠ‚ç‚¹é“¾ | é“¾å¼è¾¹çš„ `text` æœªè¢«è§£æ |

---

## ğŸ”— ä¾èµ–

- æ— å‰ç½®ä¾èµ–
- è¢«ä¾èµ–: FR-07 (è¾¹äº¤äº’ä¼˜åŒ–)
