# FR-07: è¾¹äº¤äº’ä¼˜åŒ–

> ä¼˜å…ˆçº§: P0 | çŠ¶æ€: â¬œ å¾…å¼€å§‹

## ğŸ“‹ æ¦‚è¿°

ä¼˜åŒ–è¾¹(Edge)çš„äº¤äº’ä½“éªŒï¼ŒåŒ…æ‹¬åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ç­‰æ“ä½œã€‚

---

## ğŸ¯ éœ€æ±‚

### 7.1 è¾¹åˆ›å»º

- ä»èŠ‚ç‚¹ç«¯å£æ‹–æ‹½åˆ›å»ºè¾¹
- æ‹–æ‹½åˆ°ç›®æ ‡èŠ‚ç‚¹æ—¶é«˜äº®æç¤º
- é‡Šæ”¾æ—¶åˆ›å»ºè¾¹
- æ”¯æŒé€‰æ‹©è¾¹ç±»å‹ (å¼¹å‡ºé€‰æ‹©å™¨æˆ–æŒ‰ä½ä¿®é¥°é”®)

### 7.2 è¾¹é€‰æ‹©

- ç‚¹å‡»è¾¹é€‰ä¸­
- é€‰ä¸­è¾¹è§†è§‰åé¦ˆ
- å¤šè¾¹é€‰æ‹© (Ctrl + ç‚¹å‡»)

### 7.3 è¾¹ç¼–è¾‘

- åŒå‡»è¾¹ç¼–è¾‘æ ‡ç­¾
- é€‰ä¸­è¾¹åå¯é€šè¿‡å±æ€§é¢æ¿ä¿®æ”¹:
  - è¾¹ç±»å‹ (ç®­å¤´æ ·å¼)
  - çº¿æ¡æ ·å¼ (å®çº¿/è™šçº¿/ç²—çº¿)
  - æ ‡ç­¾æ–‡æœ¬

### 7.4 è¾¹åˆ é™¤

- `Delete` / `Backspace` åˆ é™¤é€‰ä¸­è¾¹
- å³é”®èœå•åˆ é™¤

### 7.5 è¾¹è·¯å¾„è°ƒæ•´ (å¯é€‰)

- æ‹–æ‹½è¾¹çš„æ§åˆ¶ç‚¹è°ƒæ•´è·¯å¾„
- æ”¯æŒæŠ˜çº¿/æ›²çº¿åˆ‡æ¢

---

## ğŸ”§ å®ç°

### ç«¯å£(Port)ç³»ç»Ÿ

**æ–°æ–‡ä»¶:** `src/canvas/ports/PortManager.ts`

æ¯ä¸ªèŠ‚ç‚¹æœ‰å¤šä¸ªè¿æ¥ç«¯å£:

```typescript
interface Port {
  id: string;
  nodeId: string;
  position: 'top' | 'right' | 'bottom' | 'left';
  x: number;
  y: number;
}

class PortManager {
  private ports: Map<string, Port[]> = new Map();

  getPortsForNode(nodeId: string): Port[] {
    return this.ports.get(nodeId) ?? [];
  }

  updatePortPositions(node: Node): void {
    const ports: Port[] = [
      { id: `${node.id}-top`, nodeId: node.id, position: 'top', x: node.x + node.width/2, y: node.y },
      { id: `${node.id}-right`, nodeId: node.id, position: 'right', x: node.x + node.width, y: node.y + node.height/2 },
      { id: `${node.id}-bottom`, nodeId: node.id, position: 'bottom', x: node.x + node.width/2, y: node.y + node.height },
      { id: `${node.id}-left`, nodeId: node.id, position: 'left', x: node.x, y: node.y + node.height/2 },
    ];
    this.ports.set(node.id, ports);
  }

  findNearestPort(x: number, y: number, excludeNodeId?: string): Port | null {
    // æŸ¥æ‰¾æœ€è¿‘çš„ç«¯å£
  }
}
```

### EdgeCreationState

**æ–°æ–‡ä»¶:** `src/canvas/edges/EdgeCreationState.ts`

```typescript
class EdgeCreationState {
  private sourcePort: Port | null = null;
  private previewLine: { x1: number, y1: number, x2: number, y2: number } | null = null;

  startFromPort(port: Port): void {
    this.sourcePort = port;
  }

  updatePreview(mouseX: number, mouseY: number): void {
    if (!this.sourcePort) return;
    this.previewLine = {
      x1: this.sourcePort.x,
      y1: this.sourcePort.y,
      x2: mouseX,
      y2: mouseY
    };
  }

  completeToPort(targetPort: Port, model: FlowchartModel, history: CommandHistory): void {
    if (!this.sourcePort || this.sourcePort.nodeId === targetPort.nodeId) {
      this.cancel();
      return;
    }

    history.execute(new AddEdgeCommand(model, {
      id: generateId(),
      source: this.sourcePort.nodeId,
      target: targetPort.nodeId,
      stroke: 'normal',
      arrowStart: 'none',
      arrowEnd: 'arrow'
    }));

    this.cancel();
  }

  cancel(): void {
    this.sourcePort = null;
    this.previewLine = null;
  }
}
```

### EdgeRenderer å¢å¼º

**æ–‡ä»¶:** `src/canvas/edges/EdgeRenderer.ts`

æ·»åŠ :
- æ‚¬åœé«˜äº®
- é€‰ä¸­çŠ¶æ€
- å¯ç‚¹å‡»åŒºåŸŸ (çº¿æ¡è¾ƒç»†ï¼Œéœ€è¦æ‰©å±•ç‚¹å‡»åŒºåŸŸ)

```typescript
// æ‰©å±•ç‚¹å‡»åŒºåŸŸ
function renderEdgeHitArea(edge: Edge): string {
  // è¿”å›æ›´å®½çš„é€æ˜è·¯å¾„ç”¨äºç‚¹å‡»æ£€æµ‹
  return `<path d="${path}" stroke="transparent" stroke-width="20" />`;
}
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### æµ‹è¯•ç”¨ä¾‹

```typescript
describe('EdgeCreationState', () => {
  it('ä»æºç«¯å£æ‹–æ‹½åˆ°ç›®æ ‡ç«¯å£åˆ›å»ºè¾¹', () => {
    const state = new EdgeCreationState();
    const model = new FlowchartModel();
    const history = new CommandHistory();

    model.addNode({ id: 'A', text: 'A', shape: 'rect' });
    model.addNode({ id: 'B', text: 'B', shape: 'rect' });

    const sourcePort: Port = { id: 'A-right', nodeId: 'A', position: 'right', x: 100, y: 50 };
    const targetPort: Port = { id: 'B-left', nodeId: 'B', position: 'left', x: 200, y: 50 };

    state.startFromPort(sourcePort);
    state.completeToPort(targetPort, model, history);

    expect(model.edgeCount).toBe(1);
    expect(model.edges[0].source).toBe('A');
    expect(model.edges[0].target).toBe('B');
  });

  it('ä¸èƒ½è¿æ¥åˆ°åŒä¸€èŠ‚ç‚¹', () => {
    const state = new EdgeCreationState();
    const model = new FlowchartModel();
    const history = new CommandHistory();

    model.addNode({ id: 'A', text: 'A', shape: 'rect' });

    const port1: Port = { id: 'A-right', nodeId: 'A', position: 'right', x: 100, y: 50 };
    const port2: Port = { id: 'A-left', nodeId: 'A', position: 'left', x: 0, y: 50 };

    state.startFromPort(port1);
    state.completeToPort(port2, model, history);

    expect(model.edgeCount).toBe(0);
  });
});
```

### E2E æµ‹è¯•

```typescript
test('æ‹–æ‹½åˆ›å»ºè¾¹', async ({ page }) => {
  // æ‰¾åˆ°èŠ‚ç‚¹ç«¯å£
  const sourcePort = page.locator('[data-port="A-right"]');
  const targetNode = page.locator('[data-node-id="B"]');

  // æ‹–æ‹½
  await sourcePort.dragTo(targetNode);

  // éªŒè¯è¾¹åˆ›å»º
  await expect(page.locator('.edge')).toHaveCount(1);
});

test('åŒå‡»è¾¹ç¼–è¾‘æ ‡ç­¾', async ({ page }) => {
  await page.dblclick('.edge');

  // éªŒè¯ç¼–è¾‘å™¨å‡ºç°
  await expect(page.locator('input[data-testid="edge-label-editor"]')).toBeVisible();
});
```

---

## ğŸ”— ä¾èµ–

- å‰ç½®: FR-05 (æ’¤é”€é‡åš)
- è¢«ä¾èµ–: FR-09 (å³é”®èœå•å¢å¼ºéœ€è¦è¾¹æ“ä½œ)
