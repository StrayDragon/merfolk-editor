# FR-09: å³é”®èœå•å¢å¼º

> ä¼˜å…ˆçº§: P1 | çŠ¶æ€: âœ… å®Œæˆ

## ğŸ“‹ æ¦‚è¿°

å¢å¼ºå³é”®ä¸Šä¸‹æ–‡èœå•åŠŸèƒ½ï¼Œæ ¹æ®ç‚¹å‡»ç›®æ ‡æä¾›ç›¸åº”æ“ä½œã€‚

---

## ğŸ¯ éœ€æ±‚

### 9.1 ä¸Šä¸‹æ–‡æ•æ„Ÿ

æ ¹æ®ç‚¹å‡»ç›®æ ‡æ˜¾ç¤ºä¸åŒèœå•:

**ç”»å¸ƒç©ºç™½å¤„:**
- æ·»åŠ èŠ‚ç‚¹
- ç²˜è´´
- å…¨é€‰
- ç¼©æ”¾é€‰é¡¹

**èŠ‚ç‚¹:**
- ç¼–è¾‘æ–‡æœ¬
- æ›´æ”¹å½¢çŠ¶
- æ›´æ”¹æ ·å¼
- å¤åˆ¶
- å‰ªåˆ‡
- åˆ é™¤
- ä»æ­¤èŠ‚ç‚¹åˆ›å»ºè¾¹

**è¾¹:**
- ç¼–è¾‘æ ‡ç­¾
- æ›´æ”¹è¾¹ç±»å‹
- æ›´æ”¹çº¿æ¡æ ·å¼
- åˆ é™¤

**å­å›¾:**
- ç¼–è¾‘æ ‡é¢˜
- æ·»åŠ èŠ‚ç‚¹åˆ°å­å›¾
- åˆ é™¤å­å›¾

**å¤šé€‰:**
- å¯¹é½é€‰é¡¹ (å·¦å¯¹é½ã€å±…ä¸­ã€å³å¯¹é½)
- åˆ†å¸ƒé€‰é¡¹ (æ°´å¹³åˆ†å¸ƒã€å‚ç›´åˆ†å¸ƒ)
- åˆ›å»ºå­å›¾
- åˆ é™¤å…¨éƒ¨

### 9.2 å¿«æ·é”®æç¤º

èœå•é¡¹æ—æ˜¾ç¤ºå¯¹åº”å¿«æ·é”®ã€‚

### 9.3 å­èœå•

æ”¯æŒåµŒå¥—å­èœå•ï¼Œå¦‚"æ›´æ”¹å½¢çŠ¶"å±•å¼€å½¢çŠ¶åˆ—è¡¨ã€‚

---

## ğŸ”§ å®ç°

### ContextMenu ç»„ä»¶å¢å¼º

**æ–‡ä»¶:** `src/components/ContextMenu.svelte`

```svelte
<script lang="ts">
  import type { MenuItem } from './types';

  export let x: number;
  export let y: number;
  export let items: MenuItem[];
  export let onClose: () => void;

  interface MenuItem {
    id: string;
    label: string;
    icon?: string;
    shortcut?: string;
    disabled?: boolean;
    children?: MenuItem[];  // å­èœå•
    action?: () => void;
    separator?: boolean;
  }

  let activeSubmenu: string | null = null;
</script>

<div class="context-menu" style="left: {x}px; top: {y}px;">
  {#each items as item}
    {#if item.separator}
      <hr />
    {:else}
      <button
        class="menu-item"
        class:disabled={item.disabled}
        class:has-children={item.children}
        on:click={() => !item.disabled && item.action?.()}
        on:mouseenter={() => activeSubmenu = item.children ? item.id : null}
      >
        {#if item.icon}
          <span class="icon">{item.icon}</span>
        {/if}
        <span class="label">{item.label}</span>
        {#if item.shortcut}
          <span class="shortcut">{item.shortcut}</span>
        {/if}
        {#if item.children}
          <span class="arrow">â–¸</span>
        {/if}
      </button>

      {#if activeSubmenu === item.id && item.children}
        <div class="submenu">
          <svelte:self items={item.children} onClose={onClose} />
        </div>
      {/if}
    {/if}
  {/each}
</div>

<style>
  .context-menu {
    position: fixed;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    min-width: 160px;
    z-index: 1000;
  }

  .menu-item {
    display: flex;
    align-items: center;
    width: 100%;
    padding: 8px 12px;
    border: none;
    background: transparent;
    cursor: pointer;
    gap: 8px;
  }

  .menu-item:hover:not(.disabled) {
    background: var(--bg-hover);
  }

  .menu-item.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .shortcut {
    margin-left: auto;
    color: var(--text-secondary);
    font-size: 0.85em;
  }

  .submenu {
    position: absolute;
    left: 100%;
    top: 0;
  }
</style>
```

### ContextMenuManager

**æ–°æ–‡ä»¶:** `src/lib/ContextMenuManager.ts`

```typescript
type ContextType = 'canvas' | 'node' | 'edge' | 'subgraph' | 'multiselect';

interface MenuContext {
  type: ContextType;
  target?: string | string[];  // ç›®æ ‡ ID
  position: { x: number, y: number };
}

class ContextMenuManager {
  buildMenu(ctx: MenuContext, handlers: MenuHandlers): MenuItem[] {
    switch (ctx.type) {
      case 'canvas':
        return this.canvasMenu(handlers);
      case 'node':
        return this.nodeMenu(ctx.target as string, handlers);
      case 'edge':
        return this.edgeMenu(ctx.target as string, handlers);
      case 'multiselect':
        return this.multiselectMenu(ctx.target as string[], handlers);
      default:
        return [];
    }
  }

  private canvasMenu(handlers: MenuHandlers): MenuItem[] {
    return [
      { id: 'add-node', label: 'æ·»åŠ èŠ‚ç‚¹', icon: 'â•', action: handlers.addNode },
      { id: 'paste', label: 'ç²˜è´´', shortcut: 'Ctrl+V', action: handlers.paste, disabled: !handlers.canPaste },
      { separator: true },
      { id: 'select-all', label: 'å…¨é€‰', shortcut: 'Ctrl+A', action: handlers.selectAll },
    ];
  }

  private nodeMenu(nodeId: string, handlers: MenuHandlers): MenuItem[] {
    return [
      { id: 'edit', label: 'ç¼–è¾‘æ–‡æœ¬', action: () => handlers.editNode(nodeId) },
      {
        id: 'shape',
        label: 'æ›´æ”¹å½¢çŠ¶',
        children: this.shapeSubmenu(nodeId, handlers)
      },
      { separator: true },
      { id: 'copy', label: 'å¤åˆ¶', shortcut: 'Ctrl+C', action: handlers.copy },
      { id: 'cut', label: 'å‰ªåˆ‡', shortcut: 'Ctrl+X', action: handlers.cut },
      { id: 'delete', label: 'åˆ é™¤', shortcut: 'Del', action: () => handlers.deleteNode(nodeId) },
    ];
  }

  private shapeSubmenu(nodeId: string, handlers: MenuHandlers): MenuItem[] {
    const shapes = ['rect', 'rounded', 'circle', 'diamond', 'hexagon'];
    return shapes.map(shape => ({
      id: `shape-${shape}`,
      label: shape,
      action: () => handlers.changeShape(nodeId, shape)
    }));
  }
}
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### æµ‹è¯•ç”¨ä¾‹

```typescript
describe('ContextMenuManager', () => {
  it('ç”»å¸ƒèœå•åŒ…å«æ·»åŠ èŠ‚ç‚¹', () => {
    const manager = new ContextMenuManager();
    const menu = manager.buildMenu(
      { type: 'canvas', position: { x: 100, y: 100 } },
      mockHandlers
    );

    expect(menu.find(m => m.id === 'add-node')).toBeDefined();
  });

  it('èŠ‚ç‚¹èœå•åŒ…å«å½¢çŠ¶å­èœå•', () => {
    const manager = new ContextMenuManager();
    const menu = manager.buildMenu(
      { type: 'node', target: 'A', position: { x: 100, y: 100 } },
      mockHandlers
    );

    const shapeItem = menu.find(m => m.id === 'shape');
    expect(shapeItem?.children).toBeDefined();
  });
});
```

### E2E æµ‹è¯•

```typescript
test('å³é”®èŠ‚ç‚¹æ˜¾ç¤ºä¸Šä¸‹æ–‡èœå•', async ({ page }) => {
  await page.click('.node', { button: 'right' });

  await expect(page.locator('.context-menu')).toBeVisible();
  await expect(page.locator('.context-menu .menu-item')).toContainText('åˆ é™¤');
});

test('ç‚¹å‡»èœå•é¡¹æ‰§è¡Œæ“ä½œ', async ({ page }) => {
  await page.click('.node', { button: 'right' });
  await page.click('.menu-item:has-text("åˆ é™¤")');

  await expect(page.locator('.node')).toHaveCount(0);
});
```

---

## ğŸ”— ä¾èµ–

- å‰ç½®: FR-06 (èŠ‚ç‚¹äº¤äº’), FR-07 (è¾¹äº¤äº’)
- è¢«ä¾èµ–: æ— 
