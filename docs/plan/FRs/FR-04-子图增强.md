# FR-04: å­å›¾å¢å¼º

> ä¼˜å…ˆçº§: P2 | çŠ¶æ€: âœ… å®Œæˆ

## ğŸ“‹ æ¦‚è¿°

å¢å¼ºå­å›¾(Subgraph)åŠŸèƒ½,æ”¯æŒå­å›¾å†…æ–¹å‘ã€æ·±å±‚åµŒå¥—å’Œå­å›¾é—´è¿è¾¹.

å‚è€ƒ: [Mermaid Flowchart - Subgraphs](https://mermaid.js.org/syntax/flowchart.html#subgraphs)

---

## ğŸ¯ éœ€æ±‚

### 4.1 å­å›¾å†…æ–¹å‘

**è¯­æ³•:**
```mermaid
flowchart LR
  subgraph TOP
    direction TB
    A --> B
  end
  subgraph BOTTOM
    direction RL
    C --> D
  end
  TOP --> BOTTOM
```

å­å›¾å†…å¯ä»¥å£°æ˜ç‹¬ç«‹æ–¹å‘,è¦†ç›–å…¨å±€æ–¹å‘.

### 4.2 å­å›¾æ·±å±‚åµŒå¥—

**è¯­æ³•:**
```mermaid
flowchart TB
  subgraph Level1
    subgraph Level2
      subgraph Level3
        A --> B
      end
    end
  end
```

æ”¯æŒ 3+ å±‚åµŒå¥—å­å›¾.

### 4.3 å­å›¾é—´è¿è¾¹

**è¯­æ³•:**
```mermaid
flowchart TB
  subgraph one
    a1-->a2
  end
  subgraph two
    b1-->b2
  end
  one --> two
```

å­å›¾æœ¬èº«å¯ä½œä¸ºè¾¹çš„ç«¯ç‚¹.

---

## ğŸ”§ å®ç°

### Parser ä¿®æ”¹

**æ–‡ä»¶:** `src/core/parser/MermaidParser.ts`

```typescript
// è§£æå­å›¾å†…çš„ direction è¯­å¥
private parseSubGraphDirection(line: string): Direction | null {
  const match = line.match(/^\s*direction\s+(TB|TD|BT|LR|RL)\s*$/i);
  return match ? (match[1].toUpperCase() as Direction) : null;
}
```

### Model ä¿®æ”¹

**æ–‡ä»¶:** `src/core/model/SubGraph.ts`

```typescript
interface SubGraphData {
  id: string;
  title: string;
  nodeIds: string[];
  parentId?: string;       // çˆ¶å­å›¾ ID (åµŒå¥—)
  direction?: Direction;   // å­å›¾ç‹¬ç«‹æ–¹å‘
}
```

### Layout ä¿®æ”¹

**æ–‡ä»¶:** `src/canvas/layout/DagreLayout.ts`

éœ€è¦ä¸ºåµŒå¥—å­å›¾åˆ†åˆ«åˆ›å»ºå­å¸ƒå±€å¼•æ“,å¹¶åº”ç”¨å„è‡ªæ–¹å‘.

---

## âœ… éªŒæ”¶æ ‡å‡†

### æµ‹è¯•ç”¨ä¾‹

```typescript
it('è§£æå­å›¾å†… direction', () => {
  const model = parser.parse(`flowchart LR
    subgraph TOP
      direction TB
      A --> B
    end`);
  expect(model.subGraphs[0].direction).toBe('TB');
});

it('è§£æåµŒå¥—å­å›¾', () => {
  const model = parser.parse(`flowchart TB
    subgraph L1
      subgraph L2
        A
      end
    end`);
  const l2 = model.subGraphs.find(s => s.id === 'L2');
  expect(l2?.parentId).toBe('L1');
});

it('å­å›¾ä½œä¸ºè¾¹ç«¯ç‚¹', () => {
  const model = parser.parse(`flowchart TB
    subgraph one
      a1
    end
    subgraph two
      b1
    end
    one --> two`);
  expect(model.edges.find(e => e.source === 'one' && e.target === 'two')).toBeDefined();
});
```

---

## ğŸ“Š å½“å‰å¤±è´¥æµ‹è¯•

æ¥è‡ª `MermaidParser.compat.test.ts`:

- â­ï¸ `6.3 [å¾…å®ç°] å­å›¾å†…æ–¹å‘` - è·³è¿‡

---

## ğŸ”— ä¾èµ–

- æ— å‰ç½®ä¾èµ–
- å…³è”: Canvas æ¸²æŸ“éœ€è¦æ”¯æŒåµŒå¥—å¸ƒå±€
