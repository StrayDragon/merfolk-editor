# FR-06: èŠ‚ç‚¹äº¤äº’ä¼˜åŒ–

> ä¼˜å…ˆçº§: P0 | çŠ¶æ€: â¬œ å¾…å¼€å§‹

## ğŸ“‹ æ¦‚è¿°

ä¼˜åŒ–èŠ‚ç‚¹çš„äº¤äº’ä½“éªŒï¼ŒåŒ…æ‹¬é€‰æ‹©ã€æ‹–æ‹½ã€ç¼–è¾‘ç­‰æ“ä½œã€‚

---

## ğŸ¯ éœ€æ±‚

### 6.1 èŠ‚ç‚¹é€‰æ‹©

- å•å‡»é€‰ä¸­èŠ‚ç‚¹
- `Ctrl/Cmd + ç‚¹å‡»` å¤šé€‰
- `Shift + ç‚¹å‡»` èŒƒå›´é€‰æ‹©
- æ¡†é€‰ (æ‹–æ‹½çŸ©å½¢é€‰æ‹©)
- `Esc` å–æ¶ˆé€‰æ‹©
- é€‰ä¸­çŠ¶æ€è§†è§‰åé¦ˆ

### 6.2 èŠ‚ç‚¹æ‹–æ‹½

- æ‹–æ‹½ç§»åŠ¨èŠ‚ç‚¹
- å¤šé€‰æ‹–æ‹½ (æ•´ç»„ç§»åŠ¨)
- æ‹–æ‹½æ—¶å¸é™„ç½‘æ ¼ (å¯é€‰)
- æ‹–æ‹½çº¦æŸ (ä¸è¶…å‡ºç”»å¸ƒè¾¹ç•Œ)

### 6.3 èŠ‚ç‚¹ç¼–è¾‘

- åŒå‡»è¿›å…¥ç¼–è¾‘æ¨¡å¼
- å†…è”ç¼–è¾‘èŠ‚ç‚¹æ–‡æœ¬
- `Enter` ç¡®è®¤ï¼Œ`Esc` å–æ¶ˆ
- ç‚¹å‡»ç©ºç™½å¤„é€€å‡ºç¼–è¾‘

### 6.4 èŠ‚ç‚¹åˆ é™¤

- `Delete` / `Backspace` åˆ é™¤é€‰ä¸­èŠ‚ç‚¹
- åˆ é™¤èŠ‚ç‚¹æ—¶è‡ªåŠ¨åˆ é™¤ç›¸å…³è¾¹

### 6.5 èŠ‚ç‚¹å¤åˆ¶

- `Ctrl/Cmd + C` å¤åˆ¶
- `Ctrl/Cmd + V` ç²˜è´´
- `Ctrl/Cmd + D` å¤åˆ¶ (ç›´æ¥åˆ›å»ºå‰¯æœ¬)

---

## ğŸ”§ å®ç°

### SelectionManager

**æ–°æ–‡ä»¶:** `src/canvas/selection/SelectionManager.ts`

```typescript
class SelectionManager {
  private selected: Set<string> = new Set();

  select(id: string, multi: boolean = false): void {
    if (!multi) this.selected.clear();
    this.selected.add(id);
    this.emit('change', this.selectedIds);
  }

  deselect(id: string): void {
    this.selected.delete(id);
    this.emit('change', this.selectedIds);
  }

  clear(): void {
    this.selected.clear();
    this.emit('change', []);
  }

  toggle(id: string): void {
    if (this.selected.has(id)) {
      this.selected.delete(id);
    } else {
      this.selected.add(id);
    }
    this.emit('change', this.selectedIds);
  }

  get selectedIds(): string[] {
    return Array.from(this.selected);
  }

  isSelected(id: string): boolean {
    return this.selected.has(id);
  }
}
```

### DragManager

**æ–°æ–‡ä»¶:** `src/canvas/drag/DragManager.ts`

```typescript
class DragManager {
  private dragStart: { x: number, y: number } | null = null;
  private nodeStartPositions: Map<string, { x: number, y: number }> = new Map();

  startDrag(e: MouseEvent, nodeIds: string[], model: FlowchartModel): void {
    this.dragStart = { x: e.clientX, y: e.clientY };
    for (const id of nodeIds) {
      const node = model.getNode(id);
      if (node) {
        this.nodeStartPositions.set(id, { x: node.x ?? 0, y: node.y ?? 0 });
      }
    }
  }

  updateDrag(e: MouseEvent, model: FlowchartModel, history: CommandHistory): void {
    if (!this.dragStart) return;

    const dx = e.clientX - this.dragStart.x;
    const dy = e.clientY - this.dragStart.y;

    // å®æ—¶æ›´æ–°ä½ç½® (ä¸åˆ›å»ºå‘½ä»¤)
    for (const [id, start] of this.nodeStartPositions) {
      model.updateNode(id, { x: start.x + dx, y: start.y + dy });
    }
  }

  endDrag(model: FlowchartModel, history: CommandHistory): void {
    // åˆ›å»ºå•ä¸ª MoveCommand ä¿å­˜æœ€ç»ˆä½ç½®
    const moves = Array.from(this.nodeStartPositions.entries()).map(([id, start]) => {
      const node = model.getNode(id);
      return { id, from: start, to: { x: node?.x ?? 0, y: node?.y ?? 0 } };
    });

    if (moves.some(m => m.from.x !== m.to.x || m.from.y !== m.to.y)) {
      history.execute(new MoveNodesCommand(model, moves));
    }

    this.dragStart = null;
    this.nodeStartPositions.clear();
  }
}
```

### InlineEditor

**ç»„ä»¶:** `src/components/InlineEditor.svelte`

```svelte
<script lang="ts">
  export let value: string;
  export let x: number;
  export let y: number;
  export let onConfirm: (value: string) => void;
  export let onCancel: () => void;

  let input: HTMLInputElement;

  onMount(() => {
    input?.focus();
    input?.select();
  });

  function handleKeydown(e: KeyboardEvent) {
    if (e.key === 'Enter') {
      onConfirm(value);
    } else if (e.key === 'Escape') {
      onCancel();
    }
  }
</script>

<input
  bind:this={input}
  bind:value
  on:keydown={handleKeydown}
  on:blur={() => onConfirm(value)}
  style="position: absolute; left: {x}px; top: {y}px;"
/>
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### æµ‹è¯•ç”¨ä¾‹

```typescript
describe('SelectionManager', () => {
  it('å•é€‰æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©', () => {
    const sm = new SelectionManager();
    sm.select('A');
    sm.select('B');
    expect(sm.selectedIds).toEqual(['B']);
  });

  it('å¤šé€‰ä¿ç•™ä¹‹å‰çš„é€‰æ‹©', () => {
    const sm = new SelectionManager();
    sm.select('A');
    sm.select('B', true);
    expect(sm.selectedIds).toContain('A');
    expect(sm.selectedIds).toContain('B');
  });
});
```

### E2E æµ‹è¯•

```typescript
test('åŒå‡»èŠ‚ç‚¹è¿›å…¥ç¼–è¾‘æ¨¡å¼', async ({ page }) => {
  // åŒå‡»èŠ‚ç‚¹
  await page.dblclick('.node');

  // éªŒè¯è¾“å…¥æ¡†å‡ºç°
  await expect(page.locator('input[data-testid="inline-editor"]')).toBeVisible();
});

test('æ‹–æ‹½ç§»åŠ¨èŠ‚ç‚¹', async ({ page }) => {
  const node = page.locator('.node').first();
  const box = await node.boundingBox();

  await node.dragTo(page.locator('body'), {
    targetPosition: { x: box!.x + 100, y: box!.y + 100 }
  });

  // éªŒè¯ä½ç½®æ”¹å˜
  const newBox = await node.boundingBox();
  expect(newBox!.x).toBeGreaterThan(box!.x);
});
```

---

## ğŸ”— ä¾èµ–

- å‰ç½®: FR-05 (æ’¤é”€é‡åšï¼Œç”¨äºå‘½ä»¤å†å²)
- è¢«ä¾èµ–: FR-08 (å¿«æ·é”®ç³»ç»Ÿéœ€è¦è°ƒç”¨è¿™äº›æ“ä½œ)
