# FR-05: æ’¤é”€/é‡åšç³»ç»Ÿ

> ä¼˜å…ˆçº§: P0 | çŠ¶æ€: â¬œ å¾…å¼€å§‹

## ğŸ“‹ æ¦‚è¿°

å®ç°å¯é çš„æ’¤é”€(Undo)å’Œé‡åš(Redo)ç³»ç»Ÿï¼Œæ”¯æŒæ‰€æœ‰ç¼–è¾‘æ“ä½œã€‚

---

## ğŸ¯ éœ€æ±‚

### 5.1 æ”¯æŒçš„æ“ä½œ

- æ·»åŠ /åˆ é™¤èŠ‚ç‚¹
- æ·»åŠ /åˆ é™¤è¾¹
- ä¿®æ”¹èŠ‚ç‚¹å±æ€§ (æ–‡æœ¬ã€å½¢çŠ¶ã€æ ·å¼)
- ä¿®æ”¹è¾¹å±æ€§ (ç±»å‹ã€æ–‡æœ¬)
- ç§»åŠ¨èŠ‚ç‚¹ä½ç½®
- æ·»åŠ /åˆ é™¤å­å›¾
- æ‰¹é‡æ“ä½œ (å¤šé€‰åæ“ä½œ)

### 5.2 ç”¨æˆ·äº¤äº’

- `Ctrl+Z` / `Cmd+Z` - æ’¤é”€
- `Ctrl+Y` / `Cmd+Shift+Z` - é‡åš
- å·¥å…·æ æŒ‰é’® (å¯é€‰)

### 5.3 å†å²æ ˆé™åˆ¶

- é»˜è®¤ä¿å­˜ 50 æ­¥
- å¯é…ç½®

---

## ğŸ”§ å®ç°

### Command æ¨¡å¼

**æ–°æ–‡ä»¶:** `src/core/command/`

```
src/core/command/
â”œâ”€â”€ Command.ts          # å‘½ä»¤åŸºç±»
â”œâ”€â”€ CommandHistory.ts   # å†å²ç®¡ç†å™¨
â”œâ”€â”€ commands/
â”‚   â”œâ”€â”€ AddNodeCommand.ts
â”‚   â”œâ”€â”€ DeleteNodeCommand.ts
â”‚   â”œâ”€â”€ AddEdgeCommand.ts
â”‚   â”œâ”€â”€ DeleteEdgeCommand.ts
â”‚   â”œâ”€â”€ UpdateNodeCommand.ts
â”‚   â”œâ”€â”€ UpdateEdgeCommand.ts
â”‚   â”œâ”€â”€ MoveNodeCommand.ts
â”‚   â””â”€â”€ CompositeCommand.ts  # æ‰¹é‡æ“ä½œ
â””â”€â”€ index.ts
```

**Command æ¥å£:**
```typescript
interface Command {
  execute(): void;
  undo(): void;
  description?: string;
}

class CommandHistory {
  private undoStack: Command[] = [];
  private redoStack: Command[] = [];
  private maxSize: number = 50;

  execute(cmd: Command): void {
    cmd.execute();
    this.undoStack.push(cmd);
    this.redoStack = []; // æ¸…ç©ºé‡åšæ ˆ
  }

  undo(): boolean {
    const cmd = this.undoStack.pop();
    if (cmd) {
      cmd.undo();
      this.redoStack.push(cmd);
      return true;
    }
    return false;
  }

  redo(): boolean {
    const cmd = this.redoStack.pop();
    if (cmd) {
      cmd.execute();
      this.undoStack.push(cmd);
      return true;
    }
    return false;
  }

  get canUndo(): boolean { return this.undoStack.length > 0; }
  get canRedo(): boolean { return this.redoStack.length > 0; }
}
```

**AddNodeCommand ç¤ºä¾‹:**
```typescript
class AddNodeCommand implements Command {
  constructor(
    private model: FlowchartModel,
    private data: NodeData
  ) {}

  execute(): void {
    this.model.addNode(this.data);
  }

  undo(): void {
    this.model.removeNode(this.data.id);
  }
}
```

### FlowchartModel é›†æˆ

ä¸ç›´æ¥è°ƒç”¨ `model.addNode()`ï¼Œè€Œæ˜¯é€šè¿‡ CommandHistory:

```typescript
// ç¼–è¾‘å™¨ä¸­
function addNode(data: NodeData) {
  history.execute(new AddNodeCommand(model, data));
}
```

### å¿«æ·é”®ç»‘å®š

**æ–‡ä»¶:** `src/components/Editor.svelte`

```svelte
<script>
  function handleKeydown(e: KeyboardEvent) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
      e.preventDefault();
      if (e.shiftKey) {
        history.redo();
      } else {
        history.undo();
      }
    }
    if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
      e.preventDefault();
      history.redo();
    }
  }
</script>

<svelte:window on:keydown={handleKeydown} />
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### æµ‹è¯•ç”¨ä¾‹

```typescript
describe('CommandHistory', () => {
  it('æ‰§è¡Œåå¯æ’¤é”€', () => {
    const history = new CommandHistory();
    const model = new FlowchartModel();

    history.execute(new AddNodeCommand(model, { id: 'A', text: 'A', shape: 'rect' }));
    expect(model.hasNode('A')).toBe(true);

    history.undo();
    expect(model.hasNode('A')).toBe(false);
  });

  it('æ’¤é”€åå¯é‡åš', () => {
    const history = new CommandHistory();
    const model = new FlowchartModel();

    history.execute(new AddNodeCommand(model, { id: 'A', text: 'A', shape: 'rect' }));
    history.undo();
    history.redo();

    expect(model.hasNode('A')).toBe(true);
  });

  it('æ–°æ“ä½œæ¸…ç©ºé‡åšæ ˆ', () => {
    const history = new CommandHistory();
    const model = new FlowchartModel();

    history.execute(new AddNodeCommand(model, { id: 'A', text: 'A', shape: 'rect' }));
    history.undo();
    history.execute(new AddNodeCommand(model, { id: 'B', text: 'B', shape: 'rect' }));

    expect(history.canRedo).toBe(false);
  });
});
```

### E2E æµ‹è¯•

```typescript
test('Ctrl+Z æ’¤é”€èŠ‚ç‚¹æ·»åŠ ', async ({ page }) => {
  // æ·»åŠ èŠ‚ç‚¹
  await page.click('[data-testid="add-node-btn"]');
  await expect(page.locator('.node')).toHaveCount(1);

  // æ’¤é”€
  await page.keyboard.press('Control+z');
  await expect(page.locator('.node')).toHaveCount(0);
});
```

---

## ğŸ”— ä¾èµ–

- æ— å‰ç½®ä¾èµ–
- è¢«ä¾èµ–: FR-06, FR-07 (éœ€è¦é€šè¿‡å‘½ä»¤æ‰§è¡Œæ“ä½œ)
