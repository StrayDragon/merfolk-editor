# FR-01: æ–°å½¢çŠ¶è¯­æ³•è§£æ & æ–‡æœ¬å¢å¼º

> ä¼˜å…ˆçº§: P0 | çŠ¶æ€: âœ… å®Œæˆ

## ğŸ“‹ æ¦‚è¿°

æ”¯æŒ Mermaid v11.3.0+ å¼•å…¥çš„æ–°å½¢çŠ¶è¯­æ³• `@{ shape: xxx }` å’Œæ–‡æœ¬å¤„ç†å¢å¼º.

å‚è€ƒ: [Mermaid Flowchart - Expanded Node Shapes](https://mermaid.js.org/syntax/flowchart.html#expanded-node-shapes-v1130)

---

## ğŸ¯ éœ€æ±‚

### 1.1 æ–°å½¢çŠ¶è¯­æ³•è§£æ `@{}`

**è¯­æ³•æ ¼å¼:**
```mermaid
flowchart TD
  A@{ shape: rect }
  B@{ shape: rect, label: "Custom Label" }
  C@{ shape: doc, label: "Document" }
```

**æ”¯æŒçš„å±æ€§:**
- `shape` - å½¢çŠ¶ç±»å‹
- `label` - èŠ‚ç‚¹æ–‡æœ¬
- `icon` - å›¾æ ‡ (å»¶å)
- `img` - å›¾ç‰‡ (å»¶å)
- `form` - å½¢çŠ¶å˜ä½“ (å»¶å)
- `pos` - æ ‡ç­¾ä½ç½® (å»¶å)
- `w` / `h` - å®½åº¦/é«˜åº¦ (å»¶å)
- `constraint` - çº¦æŸ (å»¶å)

### 1.2 30+ æ–°å½¢çŠ¶ç±»å‹

æ ¹æ®å®˜æ–¹æ–‡æ¡£,æ–°å¢ä»¥ä¸‹å½¢çŠ¶çš„**è§£ææ”¯æŒ** (æ¸²æŸ“åœ¨ FR-03):

| è¯­ä¹‰å | çŸ­å | åˆ«å |
|--------|------|------|
| Process | rect | proc, process |
| Event | rounded | event |
| Terminal Point | stadium | terminal, pill |
| Subprocess | framed-rectangle | subprocess, fr-rect, subproc |
| Database | cylinder | cyl, db |
| Junction | filled-circle | filled, fc |
| Start | circle | circ |
| Stop | doublecircle | dblcirc |
| Decision | diamond | diam |
| Prepare | hex, hexagon | prepare |
| Data | lean-right | lean-r, in-out |
| Data | lean-left | lean-l |
| Priority Action | trapezoid | trap-t, priority |
| Manual Operation | inv-trapezoid | trap-b, inv-trap, manual |
| Manual File | flag | lin-doc |
| Manual Input | sloped-rect | sl-rect, manual-input |
| Display | curved-trapezoid | curv-trap, display |
| Document | document | doc |
| Lined Document | lined-document | lin-doc, lined-doc |
| Waved Document | wave-rect | waved-doc |
| Waved Edge | waved-lined | waved-rect |
| Card | notched-rectangle | notch-rect, card |
| Stored Data | bow-tie-rect | bow-rect, stored |
| Multi-Doc | stacked-document | docs, st-doc |
| Disk | lined-cylinder | lin-cyl, disk |
| Tinted Disk | capped-cylinder | cap-cyl, tinted |
| Loop Limit | trapezoid-pentagon | trap-pent, loop-limit |
| Collate | hourglass | collate |
| Delay | half-rounded-rect | delay, h-rounded |
| Comment | brace | comment |
| Brace | brace-r | |
| Braces | braces | |
| Lightning Bolt | bolt | lightning |
| Paper Tape | tag-rect | tagged |
| Odd | odd | |
| Triangle | triangle | tri |
| Window Pane | window-pane | win-pane |
| Divided Process | divided-rect | div-rect, div-proc |
| Lined Process | lined-rect | lin-rect, lin-proc |
| Fork/Join | fork | |
| Double Circle | dbl-circ | framed-circle |
| Cross in Circle | crossed-circle | cross-circ |
| Small Circle | sm-circ | small-circle |

### 1.3 æ–‡æœ¬å¤„ç†å¢å¼º

**Unicode æ–‡æœ¬:**
```mermaid
flowchart LR
  A["This â¤ Unicode"]
```

**Markdown æ–‡æœ¬:**
```mermaid
flowchart LR
  A["`This **is** _Markdown_`"]
```

**å¼•å·æ–‡æœ¬å»å¼•å·:**
```mermaid
flowchart LR
  A["Text with (special) chars"]
```
è§£æå `text` åº”ä¸º `Text with (special) chars`,ä¸åŒ…å«å¤–å±‚å¼•å·.

---

## ğŸ”§ å®ç°

### Parser ä¿®æ”¹

**æ–‡ä»¶:** `src/core/parser/MermaidParser.ts`

1. æ·»åŠ  `@{}` è¯­æ³•æ­£åˆ™åŒ¹é…
2. è§£æ JSON-like å±æ€§
3. å¼•å·æ–‡æœ¬å»å¼•å·å¤„ç†
4. æ‰©å±• `ShapeType` ç±»å‹

```typescript
// æ–°å½¢çŠ¶è¯­æ³•æ­£åˆ™
const NEW_SHAPE_PATTERN = /^(\w+)@\{([^}]+)\}$/;

// è§£ææ–°å½¢çŠ¶è¯­æ³•
private parseNewShapeSyntax(nodeStr: string): { id: string, shape: ShapeType, text: string } | null {
  const match = nodeStr.match(NEW_SHAPE_PATTERN);
  if (!match) return null;

  const id = match[1];
  const props = this.parseShapeProps(match[2]);

  return {
    id,
    shape: this.mapShapeName(props.shape) || 'rect',
    text: props.label || id
  };
}
```

### Model ä¿®æ”¹

**æ–‡ä»¶:** `src/core/model/types.ts`

æ‰©å±• `ShapeType`:
```typescript
export type ShapeType =
  // ç°æœ‰
  | 'rect' | 'rounded' | 'stadium' | 'subroutine' | 'cylinder'
  | 'circle' | 'doublecircle' | 'diamond' | 'hexagon'
  | 'trapezoid' | 'inv_trapezoid' | 'lean_right' | 'lean_left' | 'odd'
  // æ–°å¢
  | 'doc' | 'card' | 'delay' | 'hourglass' | 'bolt' | 'triangle'
  | 'window_pane' | 'divided_rect' | 'lined_rect' | 'fork'
  // ... å…¶ä»–æ–°å½¢çŠ¶
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### è§£ææµ‹è¯•

```typescript
it('è§£ææ–°å½¢çŠ¶è¯­æ³• @{ shape: doc }', () => {
  const model = parser.parse('flowchart TD\n  A@{ shape: doc, label: "Document" }');
  expect(model.getNode('A')?.shape).toBe('doc');
  expect(model.getNode('A')?.text).toBe('Document');
});

it('å¼•å·æ–‡æœ¬æ­£ç¡®å»å¼•å·', () => {
  const model = parser.parse('flowchart LR\n  A["Text with (parentheses)"]');
  expect(model.getNode('A')?.text).toBe('Text with (parentheses)');
});
```

---

## ğŸ“Š å½“å‰å¤±è´¥æµ‹è¯•

æ¥è‡ª `MermaidParser.compat.test.ts`:

- âŒ `8.4 å¸¦å¼•å·çš„æ–‡æœ¬ (ç‰¹æ®Šå­—ç¬¦)` - å¼•å·æœªè¢«æ­£ç¡®å»é™¤

---

## ğŸ”— ä¾èµ–

- æ— å‰ç½®ä¾èµ–
- è¢«ä¾èµ–: FR-03 (æ–°å½¢çŠ¶æ¸²æŸ“)
