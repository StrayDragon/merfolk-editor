# FR-08: å¿«æ·é”®ç³»ç»Ÿ

> ä¼˜å…ˆçº§: P1 | çŠ¶æ€: âœ… å®Œæˆ

## ğŸ“‹ æ¦‚è¿°

å®ç°ç»Ÿä¸€çš„å¿«æ·é”®ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒè‡ªå®šä¹‰å¿«æ·é”®ã€‚

---

## ğŸ¯ éœ€æ±‚

### 8.1 é»˜è®¤å¿«æ·é”®

| å¿«æ·é”® | æ“ä½œ |
|--------|------|
| `Ctrl/Cmd + Z` | æ’¤é”€ |
| `Ctrl/Cmd + Shift + Z` / `Ctrl/Cmd + Y` | é‡åš |
| `Ctrl/Cmd + C` | å¤åˆ¶ |
| `Ctrl/Cmd + V` | ç²˜è´´ |
| `Ctrl/Cmd + X` | å‰ªåˆ‡ |
| `Ctrl/Cmd + D` | å¤åˆ¶èŠ‚ç‚¹ |
| `Ctrl/Cmd + A` | å…¨é€‰ |
| `Delete` / `Backspace` | åˆ é™¤é€‰ä¸­ |
| `Escape` | å–æ¶ˆé€‰æ‹©/é€€å‡ºç¼–è¾‘ |
| `Enter` | ç¡®è®¤ç¼–è¾‘ |
| `Ctrl/Cmd + S` | ä¿å­˜ (å¯¼å‡º) |
| `+` / `-` / `Ctrl/Cmd + æ»šè½®` | ç¼©æ”¾ |
| `Ctrl/Cmd + 0` | é‡ç½®ç¼©æ”¾ |
| `Space + æ‹–æ‹½` | å¹³ç§»ç”»å¸ƒ |

### 8.2 å¿«æ·é”®ç®¡ç†å™¨

- é›†ä¸­æ³¨å†Œå’Œç®¡ç†æ‰€æœ‰å¿«æ·é”®
- æ”¯æŒæŒ‰ä¸Šä¸‹æ–‡å¯ç”¨/ç¦ç”¨
- é¿å…ä¸æµè§ˆå™¨é»˜è®¤è¡Œä¸ºå†²çª

### 8.3 å¿«æ·é”®æç¤º (å¯é€‰)

- é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºå¿«æ·é”®æç¤º
- å¿«æ·é”®å¸®åŠ©é¢æ¿ (`?` æˆ– `F1`)

---

## ğŸ”§ å®ç°

### HotkeyManager

**æ–°æ–‡ä»¶:** `src/lib/HotkeyManager.ts`

```typescript
interface HotkeyBinding {
  keys: string;                    // å¦‚ "ctrl+z", "cmd+shift+z"
  action: () => void;
  context?: string;                // ä¸Šä¸‹æ–‡ï¼Œå¦‚ 'canvas', 'editor', 'dialog'
  description?: string;
  preventDefault?: boolean;
}

class HotkeyManager {
  private bindings: HotkeyBinding[] = [];
  private activeContext: string = 'canvas';

  register(binding: HotkeyBinding): () => void {
    this.bindings.push(binding);
    return () => this.unregister(binding);
  }

  unregister(binding: HotkeyBinding): void {
    const idx = this.bindings.indexOf(binding);
    if (idx >= 0) this.bindings.splice(idx, 1);
  }

  setContext(context: string): void {
    this.activeContext = context;
  }

  handleKeydown(e: KeyboardEvent): void {
    const key = this.normalizeKey(e);

    for (const binding of this.bindings) {
      if (this.matchesKey(key, binding.keys)) {
        if (!binding.context || binding.context === this.activeContext) {
          if (binding.preventDefault !== false) {
            e.preventDefault();
          }
          binding.action();
          return;
        }
      }
    }
  }

  private normalizeKey(e: KeyboardEvent): string {
    const parts: string[] = [];
    if (e.ctrlKey || e.metaKey) parts.push('ctrl');
    if (e.shiftKey) parts.push('shift');
    if (e.altKey) parts.push('alt');
    parts.push(e.key.toLowerCase());
    return parts.join('+');
  }

  private matchesKey(pressed: string, binding: string): boolean {
    // å¤„ç† cmd/ctrl å…¼å®¹
    const normalized = binding.toLowerCase()
      .replace('cmd', 'ctrl')
      .replace('meta', 'ctrl');
    return pressed === normalized;
  }

  getAllBindings(): HotkeyBinding[] {
    return [...this.bindings];
  }
}

export const hotkeyManager = new HotkeyManager();
```

### é›†æˆåˆ° App

**æ–‡ä»¶:** `src/App.svelte`

```svelte
<script lang="ts">
  import { onMount, onDestroy } from 'svelte';
  import { hotkeyManager } from '$lib/HotkeyManager';

  onMount(() => {
    // æ³¨å†Œå…¨å±€å¿«æ·é”®
    const unsubscribes = [
      hotkeyManager.register({
        keys: 'ctrl+z',
        action: () => history.undo(),
        description: 'æ’¤é”€'
      }),
      hotkeyManager.register({
        keys: 'ctrl+shift+z',
        action: () => history.redo(),
        description: 'é‡åš'
      }),
      hotkeyManager.register({
        keys: 'delete',
        action: () => deleteSelected(),
        context: 'canvas',
        description: 'åˆ é™¤é€‰ä¸­'
      }),
      // ...
    ];

    function handleKeydown(e: KeyboardEvent) {
      hotkeyManager.handleKeydown(e);
    }

    window.addEventListener('keydown', handleKeydown);

    return () => {
      unsubscribes.forEach(fn => fn());
      window.removeEventListener('keydown', handleKeydown);
    };
  });
</script>
```

### å¿«æ·é”®å¸®åŠ©é¢æ¿

**ç»„ä»¶:** `src/components/HotkeyHelp.svelte`

```svelte
<script lang="ts">
  import { hotkeyManager } from '$lib/HotkeyManager';

  export let open = false;

  $: bindings = hotkeyManager.getAllBindings()
    .filter(b => b.description);
</script>

{#if open}
  <div class="hotkey-help">
    <h2>å¿«æ·é”®</h2>
    <table>
      {#each bindings as binding}
        <tr>
          <td><kbd>{binding.keys}</kbd></td>
          <td>{binding.description}</td>
        </tr>
      {/each}
    </table>
  </div>
{/if}
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### æµ‹è¯•ç”¨ä¾‹

```typescript
describe('HotkeyManager', () => {
  it('è§¦å‘åŒ¹é…çš„å¿«æ·é”®', () => {
    const manager = new HotkeyManager();
    const action = vi.fn();

    manager.register({ keys: 'ctrl+z', action });

    const event = new KeyboardEvent('keydown', { key: 'z', ctrlKey: true });
    manager.handleKeydown(event);

    expect(action).toHaveBeenCalled();
  });

  it('ä¸Šä¸‹æ–‡è¿‡æ»¤', () => {
    const manager = new HotkeyManager();
    const action = vi.fn();

    manager.register({ keys: 'delete', action, context: 'canvas' });
    manager.setContext('dialog');

    const event = new KeyboardEvent('keydown', { key: 'Delete' });
    manager.handleKeydown(event);

    expect(action).not.toHaveBeenCalled();
  });
});
```

### E2E æµ‹è¯•

```typescript
test('Ctrl+A å…¨é€‰èŠ‚ç‚¹', async ({ page }) => {
  // åˆ›å»ºå¤šä¸ªèŠ‚ç‚¹
  // ...

  await page.keyboard.press('Control+a');

  // éªŒè¯æ‰€æœ‰èŠ‚ç‚¹è¢«é€‰ä¸­
  const selectedCount = await page.locator('.node.selected').count();
  expect(selectedCount).toBeGreaterThan(1);
});
```

---

## ğŸ”— ä¾èµ–

- å‰ç½®: FR-05 (æ’¤é”€é‡åš), FR-06 (èŠ‚ç‚¹äº¤äº’), FR-07 (è¾¹äº¤äº’)
- è¢«ä¾èµ–: æ— 
